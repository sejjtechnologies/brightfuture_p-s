<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Parent Dashboard</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
    />
    <style>
      /* Layout */
      #sidebar {
        width: 16.666667%;
        min-height: 100vh;
        position: fixed;
        top: 0;
        left: 0;
        padding-top: 2rem;
        padding-bottom: 60px;
        z-index: 1000;
        background-color: lightblue !important;
        border-right: 1px solid rgba(0, 0, 0, 0.05);
      }

      #welcome-card {
        position: fixed;
        left: 16.666667%;
        top: 12px;
        z-index: 1001;
        width: calc(100% - 16.666667% - 2rem);
        max-width: 980px;
        background: #fff3cd !important;
        border: 1px solid #ddd !important;
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.08);
        border-radius: 6px;
      }

      .main-content {
        margin-left: 16.666667%;
        margin-top: 140px;
        padding: 1rem;
        padding-bottom: 80px;
      }

      @media (max-width: 768px) {
        #sidebar {
          display: none;
        }
        #welcome-card {
          left: 0;
          width: 100%;
        }
        .main-content {
          margin-left: 0;
          margin-top: 220px;
        }
        .btn-close {
          font-size: 0.6em !important;
        }
      }

      #welcome-card .card-body {
        background-color: transparent !important;
      }
    </style>
  </head>
  <body>
    <!-- Fixed Sidebar -->
    <div id="sidebar" class="bg-light">
      <button
        class="btn-close"
        style="position: absolute; top: 0; right: 0; font-size: 0.8em"
        onclick="hideSidebar()"
      ></button>
      <div
        class="container-fluid p-4 d-flex flex-column justify-content-center align-items-center text-center"
        style="gap: 1rem"
      >
        <div class="mb-3">
          <i class="bi bi-house-heart-fill display-4 text-primary mb-3"></i>
          <h4 class="text-primary fw-bold mb-3">
            Welcome to Bright Future P.S
          </h4>
          <p class="text-muted small mb-4" style="line-height: 1.5">
            <strong>How to use the system:</strong><br />
            ‚Ä¢ Use the search bar to find your child by name, admission number,
            or address<br />
            ‚Ä¢ View your child's academic reports and attendance records<br />
            ‚Ä¢ Check fee payments, balances, and download receipts<br />
            ‚Ä¢ Monitor term progress and important school dates<br />
            ‚Ä¢ Stay updated with your child's educational journey
          </p>
        </div>
      </div>
      <div
        class="mt-auto pb-3 px-2"
        style="
          position: fixed;
          bottom: 0;
          left: 0;
          width: 16.666667%;
          background: lightblue;
          z-index: 1001;
        "
      >
        <a
          href="/auth/logout"
          class="btn btn-danger btn-sm w-100 d-flex align-items-center"
          ><i class="bi bi-box-arrow-right"></i> Logout</a
        >
      </div>
    </div>

    <!-- Fixed Welcome Card -->
    <div id="welcome-card" class="card">
      <div
        class="card-body d-flex flex-column justify-content-center align-items-center text-center position-relative"
      >
        <button
          id="showBtn"
          style="
            position: absolute;
            top: 10px;
            left: 10px;
            font-size: 0.8em;
            background: white;
            border: 1px solid black;
            color: black;
            font-weight: bold;
            display: none;
            z-index: 1001;
          "
          onclick="showSidebar()"
        >
          <i class="bi bi-chevron-right"></i>
        </button>

        <h5
          class="card-title"
          style="color: blue; font-weight: bold; margin-bottom: 10px"
        >
          Welcome Parent
        </h5>
        {% if term_progress %}
        <p style="color: darkgreen; font-size: 0.8em; margin: 2px 0">
          {{ term_progress.term_name }} ({{ term_progress.academic_year_name }})
          - Term {{ term_progress.current_term_number }} of {{
          term_progress.total_terms_in_year }}
        </p>
        <p style="color: darkgreen; font-size: 0.7em; margin: 0">
          Days spent: {{ term_progress.days_spent }} | Remaining: {{
          term_progress.days_remaining }}
        </p>
        {% endif %}
      </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
      <div class="container-fluid">
        <!-- Search Section -->
        <div class="row mb-4">
          <div class="col-12">
            <div class="card shadow-sm">
              <div class="card-body">
                <h5 class="card-title mb-3">
                  <i class="bi bi-search me-2"></i>Find Your Child
                </h5>
                <div class="row g-3">
                  <div class="col-md-6">
                    <input
                      type="text"
                      class="form-control"
                      id="searchInput"
                      placeholder="Search by first name, last name, admission number, address, or nationality..."
                      style="
                        border-radius: 25px;
                        padding: 12px 20px;
                        border: 2px solid #e9ecef;
                      "
                    />
                  </div>
                  <div class="col-md-3">
                    <button
                      class="btn btn-primary w-100"
                      style="border-radius: 25px; padding: 12px 20px"
                      onclick="searchPupils()"
                    >
                      <i class="bi bi-search me-2"></i>Search
                    </button>
                  </div>
                  <div class="col-md-3">
                    <button
                      class="btn btn-outline-secondary w-100"
                      style="border-radius: 25px; padding: 12px 20px"
                      onclick="clearSearch()"
                    >
                      <i class="bi bi-x-circle me-2"></i>Clear
                    </button>
                  </div>
                </div>
                <div id="searchResults" class="mt-3" style="display: none">
                  <div class="alert alert-info">
                    <i class="bi bi-info-circle me-2"></i>
                    Search results will appear here. Select a child to access
                    their information.
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Action Buttons (hidden until a pupil is selected) -->
        <div class="row" id="parentServicesCard" style="display: none">
          <div class="col-12">
            <div class="card shadow-sm">
              <div class="card-body">
                <h5 class="card-title mb-4">
                  <i class="bi bi-grid me-2"></i>Parent Services for
                  <span id="selectedPupilName" class="fw-semibold"></span>
                </h5>
                <div class="row g-3">
                  <div class="col-md-6 col-lg-3">
                    <button
                      id="btnReports"
                      class="btn btn-success w-100 p-3"
                      style="border-radius: 15px; min-height: 80px"
                      onclick="viewReports()"
                    >
                      <i class="bi bi-file-earmark-text display-6 mb-2"></i
                      ><br />
                      <span class="fw-bold">Academic Reports</span><br />
                      <small class="text-muted">View grades & progress</small>
                    </button>
                  </div>
                  <div class="col-md-6 col-lg-3">
                    <button
                      id="btnAttendance"
                      class="btn btn-info w-100 p-3"
                      style="border-radius: 15px; min-height: 80px"
                      onclick="viewAttendance()"
                    >
                      <i class="bi bi-calendar-check display-6 mb-2"></i><br />
                      <span class="fw-bold">Attendance</span><br />
                      <small class="text-muted">Weekly & term records</small>
                    </button>
                  </div>
                  <div class="col-md-6 col-lg-3">
                    <button
                      id="btnFees"
                      class="btn btn-warning w-100 p-3"
                      style="border-radius: 15px; min-height: 80px"
                      onclick="viewFees()"
                    >
                      <i class="bi bi-cash-coin display-6 mb-2"></i><br />
                      <span class="fw-bold">Fee Management</span><br />
                      <small class="text-muted">Payments & receipts</small>
                    </button>
                  </div>
                  <div class="col-md-6 col-lg-3">
                    <button
                      id="btnTermInfo"
                      class="btn btn-primary w-100 p-3"
                      style="border-radius: 15px; min-height: 80px"
                      onclick="viewTermInfo()"
                    >
                      <i class="bi bi-calendar-event display-6 mb-2"></i><br />
                      <span class="fw-bold">Term Information</span><br />
                      <small class="text-muted">Progress & schedule</small>
                    </button>
                  </div>
                </div>
                <div class="mt-3 text-center">
                  <button
                    class="btn btn-outline-secondary"
                    onclick="clearSelection()"
                  >
                    <i class="bi bi-x-circle me-2"></i>Clear Selection
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Term Progress Card -->
        {% if term_progress %}
        <div class="row mt-4">
          <div class="col-12">
            <div class="card shadow-sm">
              <div class="card-header bg-primary text-white">
                <h6 class="mb-0">
                  <i class="bi bi-calendar-week me-2"></i>Current Term Progress
                </h6>
              </div>
              <div class="card-body">
                <div class="row text-center">
                  <div class="col-md-3">
                    <div class="p-3 bg-light rounded">
                      <h4 class="text-primary mb-1">
                        {{ term_progress.term_name }}
                      </h4>
                      <small class="text-muted">Current Term</small>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="p-3 bg-success rounded">
                      <h4 class="text-white mb-1">
                        {{ term_progress.days_spent }}
                      </h4>
                      <small class="text-white-50">Days Completed</small>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="p-3 bg-warning rounded">
                      <h4 class="text-dark mb-1">
                        {{ term_progress.days_remaining }}
                      </h4>
                      <small class="text-dark">Days Remaining</small>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="p-3 bg-info rounded">
                      <h4 class="text-white mb-1">
                        {{ term_progress.total_term_days }}
                      </h4>
                      <small class="text-white-50">Total Term Days</small>
                    </div>
                  </div>
                </div>
                <div class="mt-3">
                  <div class="progress" style="height: 20px">
                    <div
                      class="progress-bar bg-success"
                      role="progressbar"
                      style="width: {{ (term_progress.days_spent / term_progress.total_term_days * 100)|round(1) }}%"
                      aria-valuenow="{{ term_progress.days_spent }}"
                      aria-valuemin="0"
                      aria-valuemax="{{ term_progress.total_term_days }}"
                    >
                      {{ ((term_progress.days_spent /
                      term_progress.total_term_days * 100)|round(1)) }}%
                      Complete
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        {% endif %}
      </div>
    </div>

    <script>
      function hideSidebar() {
        const sidebar = document.getElementById("sidebar");
        const welcomeCard = document.getElementById("welcome-card");

        if (window.innerWidth <= 768) {
          sidebar.classList.add("hidden");
          welcomeCard.style.left = "0";
        } else {
          sidebar.style.display = "none";
          welcomeCard.style.left = "0";
        }
        document.getElementById("showBtn").style.display = "block";
      }

      function showSidebar() {
        const sidebar = document.getElementById("sidebar");
        const welcomeCard = document.getElementById("welcome-card");

        sidebar.classList.remove("hidden");
        sidebar.style.display = "block";

        if (window.innerWidth > 768) {
          welcomeCard.style.left = "16.666667%";
        } else {
          welcomeCard.style.left = "0";
        }
        document.getElementById("showBtn").style.display = "none";
      }

      // Handle window resize
      window.addEventListener("resize", function () {
        const sidebar = document.getElementById("sidebar");
        const welcomeCard = document.getElementById("welcome-card");

        if (window.innerWidth > 768) {
          if (!sidebar.classList.contains("hidden")) {
            welcomeCard.style.left = "16.666667%";
          }
        } else {
          welcomeCard.style.left = "0";
        }
      });

      // Search functionality
      function searchPupils() {
        const searchTerm = document.getElementById("searchInput").value.trim();
        const resultsDiv = document.getElementById("searchResults");

        if (!searchTerm) {
          alert("Please enter a search term");
          return;
        }

        // Show loading state
        resultsDiv.style.display = "block";
        resultsDiv.innerHTML = `
          <div class="alert alert-info">
            <i class="bi bi-hourglass-split me-2"></i>
            Searching for "${searchTerm}"...
          </div>
        `;

        // Make AJAX request to search endpoint
        fetch('/parent/search_pupils', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ search_term: searchTerm })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            if (data.count > 0) {
              let resultsHtml = `
                <div class="alert alert-success">
                  <i class="bi bi-check-circle me-2"></i>
                  Found ${data.count} pupil(s) matching "${searchTerm}"
                </div>
                <div class="row">
              `;

              data.pupils.forEach(pupil => {
                resultsHtml += `
                  <div class="col-md-6 mb-3">
                    <div class="card h-100">
                      <div class="card-body">
                        <h6 class="card-title">
                          <i class="bi bi-person-circle me-2"></i>${pupil.full_name}
                        </h6>
                        <div class="row">
                          <div class="col-sm-6">
                            <small class="text-muted">Admission No:</small><br>
                            <strong>${pupil.admission_number}</strong>
                          </div>
                          <div class="col-sm-6">
                            <small class="text-muted">Class:</small><br>
                            <strong>${pupil.current_class}</strong>
                          </div>
                        </div>
                        <div class="row mt-2">
                          <div class="col-sm-6">
                            <small class="text-muted">Stream:</small><br>
                            <strong>${pupil.current_stream}</strong>
                          </div>
                          <div class="col-sm-6">
                            <small class="text-muted">Nationality:</small><br>
                            <strong>${pupil.nationality}</strong>
                          </div>
                        </div>
                        <div class="mt-2">
                          <small class="text-muted">Address:</small><br>
                          <strong>${pupil.address}</strong>
                        </div>
                        <div class="mt-2">
                          <small class="text-muted">Parent:</small><br>
                          <strong>${pupil.parent_name}</strong> (${pupil.parent_phone})
                        </div>
                        <div class="mt-3">
                          <button class="btn btn-primary btn-sm me-2" onclick="selectPupil(${pupil.id}, ${JSON.stringify(pupil.full_name)}, 'details')">
                            <i class="bi bi-eye me-1"></i>View Details
                          </button>
                          <button class="btn btn-success btn-sm" onclick="selectPupil(${pupil.id}, ${JSON.stringify(pupil.full_name)}, 'reports')">
                            <i class="bi bi-file-earmark-text me-1"></i>View Reports
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                `;
              });

              resultsHtml += `
                </div>
              `;

              resultsDiv.innerHTML = resultsHtml;
            } else {
              resultsDiv.innerHTML = `
                <div class="alert alert-warning">
                  <i class="bi bi-exclamation-triangle me-2"></i>
                  No pupils found matching "${searchTerm}". Try different search terms.
                </div>
              `;
            }
          } else {
            resultsDiv.innerHTML = `
              <div class="alert alert-danger">
                <i class="bi bi-x-circle me-2"></i>
                Search failed: ${data.error}
              </div>
            `;
          }
        })
        .catch(error => {
          console.error('Search error:', error);
          resultsDiv.innerHTML = `
            <div class="alert alert-danger">
              <i class="bi bi-x-circle me-2"></i>
              Search failed. Please try again.
            </div>
          `;
        });
      }

      function clearSearch() {
        document.getElementById("searchInput").value = "";
        document.getElementById("searchResults").style.display = "none";
      }

      // Selection handling: select a pupil and reveal Parent Services
      let selectedPupilId = null;

      function selectPupil(pupilId, pupilFullName, action=null) {
        selectedPupilId = pupilId;
        document.getElementById('selectedPupilName').innerText = pupilFullName;
        const card = document.getElementById('parentServicesCard');
        if (card) card.style.display = 'block';
        // Scroll into view of the services
        card.scrollIntoView({ behavior: 'smooth', block: 'start' });

        // If caller requested immediate action, trigger it
        if (action === 'reports') {
          viewReports();
        } else if (action === 'details') {
          // Open details modal or show details (placeholder)
          alert(`üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Child Details\n\nSelected pupil ID: ${pupilId} - ${pupilFullName}\n\nFeature coming soon!`);
        }
      }

      function clearSelection() {
        selectedPupilId = null;
        document.getElementById('selectedPupilName').innerText = '';
        const card = document.getElementById('parentServicesCard');
        if (card) card.style.display = 'none';
      }

      // Action button functions
      function viewReports() {
        alert("üìä Academic Reports\n\nThis feature will allow you to view your child's:\n‚Ä¢ Term grades and marks\n‚Ä¢ Subject-wise performance\n‚Ä¢ Progress reports\n‚Ä¢ Academic achievements\n\nFeature coming soon!");
      }

      function viewAttendance() {
        alert("üìÖ Attendance Records\n\nThis feature will show:\n‚Ä¢ Daily attendance for the current week\n‚Ä¢ Monthly attendance summary\n‚Ä¢ Term attendance percentage\n‚Ä¢ Absence reasons and notes\n\nFeature coming soon!");
      }

      function viewFees() {
        alert("üí∞ Fee Management\n\nThis feature will provide:\n‚Ä¢ Fee payment history\n‚Ä¢ Outstanding balance\n‚Ä¢ Payment receipts\n‚Ä¢ Fee structure breakdown\n‚Ä¢ Payment due dates\n\nFeature coming soon!");
      }

      function viewTermInfo() {
        {% if term_progress %}
        const termProgress = {{ term_progress|tojson }};
        alert(`üìö Term Information\n\nCurrent Term: ${termProgress.term_name}\nAcademic Year: ${termProgress.academic_year_name}\nTerm Number: ${termProgress.current_term_number} of ${termProgress.total_terms_in_year}\n\nProgress:\n‚Ä¢ Days Completed: ${termProgress.days_spent}\n‚Ä¢ Days Remaining: ${termProgress.days_remaining}\n‚Ä¢ Total Term Days: ${termProgress.total_term_days}\n\nKeep track of your child's academic journey!`);
        {% else %}
        alert("üìö Term Information\n\nNo current term information available.\n\nThis would normally show:\n‚Ä¢ Current term name and academic year\n‚Ä¢ Days spent and remaining\n‚Ä¢ Term progress percentage\n‚Ä¢ Important dates and deadlines");
        {% endif %}
      }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    {% include 'footer.html' %}
  </body>
</html>
