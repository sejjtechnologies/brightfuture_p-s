<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
    />
    <style>
      @media (max-width: 768px) {
        .btn-close {
          font-size: 0.6em !important;
        }
      }
    </style>
  </head>
  <body>
    <div class="container-fluid">
      <div class="row">
        <div
          id="sidebar"
          class="col-12 col-md-2 bg-light"
          style="
            min-height: 100vh;
            background-color: lightblue !important;
            position: relative;
            padding-top: 2px;
          "
        >
          <button
            class="btn-close"
            style="position: absolute; top: 0; right: 0; font-size: 0.8em"
            onclick="hideSidebar()"
          ></button>
          <div class="d-flex flex-column justify-content-end h-100 pb-3">
            <a href="/auth/logout" class="btn btn-danger btn-sm"
              ><i class="bi bi-box-arrow-right"></i> Logout</a
            >
          </div>
        </div>
        <div
          class="col-12 col-md-10"
          style="position: relative; padding-bottom: 80px"
        >
          <button
            id="showBtn"
            style="
              position: absolute;
              top: 0;
              left: 0;
              font-size: 0.8em;
              background: white;
              border: 1px solid black;
              color: black;
              font-weight: bold;
              display: none;
            "
            onclick="showSidebar()"
          >
            <i class="bi bi-chevron-left"></i>
          </button>
          <div class="container" style="margin-top: 1px">
            <div
              id="welcomeCard"
              class="card"
              style="background-color: lightgreen"
            >
              <div
                class="card-body d-flex flex-column justify-content-center align-items-center text-center position-relative"
              >
                <!-- Notification Icon -->
                <button
                  id="notificationBtn"
                  class="btn position-absolute"
                  style="
                    top: 10px;
                    right: 10px;
                    padding: 2px 6px;
                    background: none;
                    border: none;
                  "
                  onclick="toggleNotifications()"
                >
                  <i
                    class="bi bi-envelope"
                    style="font-size: 1.2em; color: #6c757d"
                  ></i>
                  {% if unread_count > 0 %}
                  <span
                    id="unreadBadge"
                    class="badge bg-danger position-absolute"
                    style="
                      top: -5px;
                      right: -5px;
                      font-size: 0.7em;
                      padding: 2px 4px;
                    "
                  >
                    {{ unread_count }}
                  </span>
                  {% endif %}
                </button>

                <h5
                  class="card-title"
                  style="color: blue; font-weight: bold; margin-bottom: 10px"
                >
                  Welcome Headteacher
                </h5>
                {% if term_progress %}
                <p style="color: darkgreen; font-size: 0.8em; margin: 2px 0">
                  {{ term_progress.term_name }} ({{
                  term_progress.academic_year_name }}) - Term {{
                  term_progress.current_term_number }} of {{
                  term_progress.total_terms_in_year }}
                </p>
                <p style="color: darkgreen; font-size: 0.7em; margin: 0">
                  Days spent: {{ term_progress.days_spent }} | Remaining: {{
                  term_progress.days_remaining }}
                </p>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <script>
      function hideSidebar() {
        document.getElementById("sidebar").style.display = "none";
        document.getElementById("showBtn").style.display = "block";
      }
      function showSidebar() {
        document.getElementById("sidebar").style.display = "block";
        document.getElementById("showBtn").style.display = "none";
      }

      // Notification functions
      function toggleNotifications() {
        const modal = new bootstrap.Modal(
          document.getElementById("notificationModal")
        );
        modal.show();

        // Mark notifications as read
        fetch("/mark_notifications_read", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              // Hide the unread badge
              const badge = document.getElementById("unreadBadge");
              if (badge) {
                badge.style.display = "none";
              }
            }
          })
          .catch((error) =>
            console.error("Error marking notifications as read:", error)
          );
      }
    </script>

    <!-- Notification Modal -->
    <div
      class="modal fade"
      id="notificationModal"
      tabindex="-1"
      aria-labelledby="notificationModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="notificationModalLabel">
              <i class="bi bi-bell me-2"></i>Notifications & Announcements
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div
            class="modal-body"
            style="max-height: 60vh; overflow-y: auto; overflow-x: hidden"
          >
            {% if notifications %} {% for notification in notifications %}
            <div
              class="card mb-3 border-0 shadow-sm"
              style="
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                border-radius: 15px;
                word-wrap: break-word;
              "
            >
              <div class="card-body">
                <div class="d-flex align-items-start">
                  <div class="flex-shrink-0 me-3">
                    <div
                      style="
                        width: 40px;
                        height: 40px;
                        background: rgba(255, 255, 255, 0.2);
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                      "
                    >
                      <i class="bi bi-bell-fill text-white"></i>
                    </div>
                  </div>
                  <div class="flex-grow-1">
                    <h6
                      class="card-title mb-2 fw-bold"
                      style="font-size: 1.1rem"
                    >
                      {{ notification.title }}
                    </h6>
                    <p
                      class="card-text mb-2"
                      style="font-size: 0.95rem; line-height: 1.4"
                    >
                      {{ notification.message }}
                    </p>
                    <small class="text-white-50" style="font-size: 0.8rem">
                      <i class="bi bi-person-circle me-1"></i>{{
                      notification.creator.username }} â€¢
                      <i class="bi bi-clock me-1"></i>{{
                      notification.created_at|eat_time }}
                    </small>
                  </div>
                </div>
              </div>
            </div>
            {% endfor %} {% else %}
            <div class="text-center text-muted py-4">
              <i class="bi bi-bell-slash display-4 mb-3"></i>
              <p>No notifications available.</p>
            </div>
            {% endif %}
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Close
            </button>
          </div>
        </div>
      </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    {% include 'footer.html' %}
  </body>
</html>
