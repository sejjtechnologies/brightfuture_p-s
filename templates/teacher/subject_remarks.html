{% extends "teacher/dashboard.html" %} {% block title %}Subject Remarks -
Teacher Dashboard{% endblock %} {% block content %}
<div class="row">
    <div class="col-12">
      <div class="card">
        <div
          class="card-header d-flex justify-content-between align-items-center"
        >
          <h5 class="mb-0">Subject Remarks</h5>
          <button
            class="btn btn-primary"
            data-bs-toggle="modal"
            data-bs-target="#createRemarkModal"
          >
            <i class="fas fa-plus"></i> Add Remark
          </button>
        </div>
        <div class="card-body">
          <!-- Filters -->
          <div class="row mb-3">
            <div class="col-md-3">
              <select class="form-select" id="classFilter">
                <option value="">All Classes</option>
                {% for assignment in assignments %}
                <option value="{{ assignment.class_stream.class_id }}">
                  {{ assignment.class_stream.school_class.name }}
                </option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-3">
              <select class="form-select" id="subjectFilter">
                <option value="">All Subjects</option>
                {% for assignment in assignments %}
                <option value="{{ assignment.subject.id }}">
                  {{ assignment.subject.name }}
                </option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-3">
              <select class="form-select" id="pupilFilter">
                <option value="">All Pupils</option>
                {% for pupil in pupils %}
                <option value="{{ pupil.id }}">
                  {{ pupil.first_name }} {{ pupil.last_name }}
                </option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-3">
              <button
                class="btn btn-outline-secondary w-100"
                onclick="clearFilters()"
              >
                <i class="fas fa-times"></i> Clear Filters
              </button>
            </div>
          </div>

          <div class="table-responsive">
            <table class="table table-striped table-hover" id="remarksTable">
              <thead>
                <tr>
                  <th>Pupil Name</th>
                  <th>Class</th>
                  <th>Subject</th>
                  <th>Remark</th>
                  <th>Remark Type</th>
                  <th>Date</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <!-- Remarks will be loaded via AJAX -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div><!-- Create Remark Modal -->
<div class="modal fade" id="createRemarkModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add Subject Remark</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <form id="createRemarkForm">
        <div class="modal-body">
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="pupilSelect" class="form-label">Pupil</label>
                <select
                  class="form-select"
                  id="pupilSelect"
                  name="pupil_id"
                  required
                >
                  <option value="">Select Pupil</option>
                  {% for pupil in pupils %}
                  <option value="{{ pupil.id }}">
                    {{ pupil.first_name }} {{ pupil.last_name }} ({{
                    pupil.current_class.name }})
                  </option>
                  {% endfor %}
                </select>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label for="remarkSubject" class="form-label">Subject</label>
                <select
                  class="form-select"
                  id="remarkSubject"
                  name="subject_id"
                  required
                >
                  <option value="">Select Subject</option>
                  {% for assignment in assignments %}
                  <option value="{{ assignment.subject.id }}">
                    {{ assignment.subject.name }}
                  </option>
                  {% endfor %}
                </select>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="remarkType" class="form-label">Remark Type</label>
                <select
                  class="form-select"
                  id="remarkType"
                  name="remark_type"
                  required
                >
                  <option value="">Select Type</option>
                  <option value="academic">Academic Performance</option>
                  <option value="behavior">Behavior</option>
                  <option value="participation">Participation</option>
                  <option value="improvement">Improvement</option>
                  <option value="concern">Concern</option>
                  <option value="praise">Praise</option>
                </select>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label for="remarkDate" class="form-label">Date</label>
                <input
                  type="date"
                  class="form-control"
                  id="remarkDate"
                  name="remark_date"
                  required
                />
              </div>
            </div>
          </div>
          <div class="mb-3">
            <label for="remarkText" class="form-label">Remark</label>
            <textarea
              class="form-control"
              id="remarkText"
              name="remark"
              rows="4"
              required
              placeholder="Enter your remark about the pupil's performance in this subject..."
            ></textarea>
          </div>
          <div class="mb-3">
            <label for="remarkNotes" class="form-label"
              >Additional Notes (Optional)</label
            >
            <textarea
              class="form-control"
              id="remarkNotes"
              name="additional_notes"
              rows="2"
              placeholder="Any additional notes or observations..."
            ></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            data-bs-dismiss="modal"
          >
            Cancel
          </button>
          <button type="submit" class="btn btn-primary">Save Remark</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  $(document).ready(function () {
    loadRemarks();

    // Set default date to today
    $("#remarkDate").val(new Date().toISOString().split("T")[0]);

    $("#createRemarkForm").on("submit", function (e) {
      e.preventDefault();

      const formData = {
        pupil_id: $("#pupilSelect").val(),
        subject_id: $("#remarkSubject").val(),
        remark_type: $("#remarkType").val(),
        remark_date: $("#remarkDate").val(),
        remark: $("#remarkText").val(),
        additional_notes: $("#remarkNotes").val(),
      };

      $.ajax({
        url: "/teacher/api/subject-remarks",
        method: "POST",
        contentType: "application/json",
        data: JSON.stringify(formData),
        success: function (response) {
          $("#createRemarkModal").modal("hide");
          $("#createRemarkForm")[0].reset();
          $("#remarkDate").val(new Date().toISOString().split("T")[0]);
          loadRemarks();
          showToast("Remark saved successfully!", "success");
        },
        error: function (xhr) {
          const error = xhr.responseJSON?.error || "Failed to save remark";
          showToast(error, "error");
        },
      });
    });

    // Filter functionality
    $("#classFilter, #subjectFilter, #pupilFilter").on("change", function () {
      loadRemarks();
    });

    function loadRemarks() {
      const filters = {
        class_id: $("#classFilter").val(),
        subject_id: $("#subjectFilter").val(),
        pupil_id: $("#pupilFilter").val(),
      };

      $.ajax({
        url: "/teacher/api/subject-remarks",
        method: "GET",
        data: filters,
        success: function (data) {
          const tbody = $("#remarksTable tbody");
          tbody.empty();

          if (data.length === 0) {
            tbody.append(
              '<tr><td colspan="7" class="text-center">No remarks found</td></tr>'
            );
            return;
          }

          data.forEach(function (remark) {
            const remarkTypeBadge = getRemarkTypeBadge(remark.remark_type);
            const row = `
                        <tr>
                            <td>${remark.pupil_name}</td>
                            <td>${remark.class_name}</td>
                            <td>${remark.subject_name}</td>
                            <td>${remark.remark}</td>
                            <td>${remarkTypeBadge}</td>
                            <td>${remark.remark_date}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary me-1" onclick="viewRemark(${remark.id})">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-warning me-1" onclick="editRemark(${remark.id})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteRemark(${remark.id})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
            tbody.append(row);
          });
        },
        error: function () {
          showToast("Failed to load remarks", "error");
        },
      });
    }

    function getRemarkTypeBadge(type) {
      const badges = {
        academic: '<span class="badge bg-primary">Academic</span>',
        behavior: '<span class="badge bg-warning">Behavior</span>',
        participation: '<span class="badge bg-success">Participation</span>',
        improvement: '<span class="badge bg-info">Improvement</span>',
        concern: '<span class="badge bg-danger">Concern</span>',
        praise: '<span class="badge bg-success">Praise</span>',
      };
      return badges[type] || '<span class="badge bg-secondary">Other</span>';
    }

    window.clearFilters = function () {
      $("#classFilter, #subjectFilter, #pupilFilter").val("");
      loadRemarks();
    };

    window.viewRemark = function (id) {
      // TODO: Implement view remark details
      showToast("View remark functionality coming soon!", "info");
    };

    window.editRemark = function (id) {
      // TODO: Implement edit remark
      showToast("Edit remark functionality coming soon!", "info");
    };

    window.deleteRemark = function (id) {
      if (confirm("Are you sure you want to delete this remark?")) {
        // TODO: Implement delete remark
        showToast("Delete remark functionality coming soon!", "info");
      }
    };
  });
</script>
{% endblock %}

