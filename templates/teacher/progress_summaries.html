{% extends "teacher/dashboard.html" %} {% block title %}Progress Summaries -
Teacher Dashboard{% endblock %} {% block content %}
<div class="row">
    <div class="col-12">
      <div class="card">
        <div
          class="card-header d-flex justify-content-between align-items-center"
        >
          <h5 class="mb-0">Progress Summaries</h5>
          <button
            class="btn btn-primary"
            data-bs-toggle="modal"
            data-bs-target="#createSummaryModal"
          >
            <i class="fas fa-plus"></i> Create Summary
          </button>
        </div>
        <div class="card-body">
          <!-- Filters -->
          <div class="row mb-3">
            <div class="col-md-4">
              <select class="form-select" id="classFilter">
                <option value="">All Classes</option>
                {% for assignment in assignments %}
                <option value="{{ assignment.class_stream.class_id }}">
                  {{ assignment.class_stream.school_class.name }}
                </option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-4">
              <select class="form-select" id="pupilFilter">
                <option value="">All Pupils</option>
                {% for pupil in pupils %}
                <option value="{{ pupil.id }}">
                  {{ pupil.first_name }} {{ pupil.last_name }}
                </option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-4">
              <button
                class="btn btn-outline-secondary w-100"
                onclick="clearFilters()"
              >
                <i class="fas fa-times"></i> Clear Filters
              </button>
            </div>
          </div>

          <div class="table-responsive">
            <table class="table table-striped table-hover" id="summariesTable">
              <thead>
                <tr>
                  <th>Pupil Name</th>
                  <th>Class</th>
                  <th>Term</th>
                  <th>Overall Grade</th>
                  <th>Attendance %</th>
                  <th>Status</th>
                  <th>Created</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <!-- Progress summaries will be loaded via AJAX -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div><!-- Create Progress Summary Modal -->
<div class="modal fade" id="createSummaryModal" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Create Progress Summary</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <form id="createSummaryForm">
        <div class="modal-body">
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="summaryPupil" class="form-label">Pupil</label>
                <select
                  class="form-select"
                  id="summaryPupil"
                  name="pupil_id"
                  required
                >
                  <option value="">Select Pupil</option>
                  {% for pupil in pupils %}
                  <option value="{{ pupil.id }}">
                    {{ pupil.first_name }} {{ pupil.last_name }} ({{
                    pupil.current_class.name }})
                  </option>
                  {% endfor %}
                </select>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label for="summaryTerm" class="form-label">Term</label>
                <select
                  class="form-select"
                  id="summaryTerm"
                  name="term_id"
                  required
                >
                  <option value="">Select Term</option>
                  <!-- Terms will be loaded via AJAX -->
                </select>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-md-4">
              <div class="mb-3">
                <label for="overallGrade" class="form-label"
                  >Overall Grade</label
                >
                <select
                  class="form-select"
                  id="overallGrade"
                  name="overall_grade"
                  required
                >
                  <option value="">Select Grade</option>
                  <option value="A">A - Excellent</option>
                  <option value="B">B - Very Good</option>
                  <option value="C">C - Good</option>
                  <option value="D">D - Satisfactory</option>
                  <option value="E">E - Needs Improvement</option>
                  <option value="F">F - Fail</option>
                </select>
              </div>
            </div>
            <div class="col-md-4">
              <div class="mb-3">
                <label for="attendancePercentage" class="form-label"
                  >Attendance Percentage</label
                >
                <input
                  type="number"
                  class="form-control"
                  id="attendancePercentage"
                  name="attendance_percentage"
                  min="0"
                  max="100"
                  step="0.1"
                  required
                />
              </div>
            </div>
            <div class="col-md-4">
              <div class="mb-3">
                <label for="summaryStatus" class="form-label">Status</label>
                <select
                  class="form-select"
                  id="summaryStatus"
                  name="status"
                  required
                >
                  <option value="">Select Status</option>
                  <option value="excellent">Excellent Progress</option>
                  <option value="good">Good Progress</option>
                  <option value="satisfactory">Satisfactory</option>
                  <option value="needs_improvement">Needs Improvement</option>
                  <option value="concern">Cause for Concern</option>
                </select>
              </div>
            </div>
          </div>
          <div class="mb-3">
            <label for="academicPerformance" class="form-label"
              >Academic Performance Summary</label
            >
            <textarea
              class="form-control"
              id="academicPerformance"
              name="academic_performance"
              rows="3"
              required
              placeholder="Summarize the pupil's academic performance this term..."
            ></textarea>
          </div>
          <div class="mb-3">
            <label for="strengths" class="form-label">Strengths</label>
            <textarea
              class="form-control"
              id="strengths"
              name="strengths"
              rows="2"
              placeholder="List the pupil's key strengths..."
            ></textarea>
          </div>
          <div class="mb-3">
            <label for="areasForImprovement" class="form-label"
              >Areas for Improvement</label
            >
            <textarea
              class="form-control"
              id="areasForImprovement"
              name="areas_for_improvement"
              rows="2"
              placeholder="Areas where the pupil needs to improve..."
            ></textarea>
          </div>
          <div class="mb-3">
            <label for="recommendations" class="form-label"
              >Recommendations</label
            >
            <textarea
              class="form-control"
              id="recommendations"
              name="recommendations"
              rows="2"
              placeholder="Recommendations for the pupil and parents..."
            ></textarea>
          </div>
          <div class="mb-3">
            <label for="additionalComments" class="form-label"
              >Additional Comments</label
            >
            <textarea
              class="form-control"
              id="additionalComments"
              name="additional_comments"
              rows="2"
              placeholder="Any additional comments or observations..."
            ></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            data-bs-dismiss="modal"
          >
            Cancel
          </button>
          <button type="submit" class="btn btn-primary">Save Summary</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  $(document).ready(function () {
    loadSummaries();
    loadTerms();

    $("#createSummaryForm").on("submit", function (e) {
      e.preventDefault();

      const formData = {
        pupil_id: $("#summaryPupil").val(),
        term_id: $("#summaryTerm").val(),
        overall_grade: $("#overallGrade").val(),
        attendance_percentage: parseFloat($("#attendancePercentage").val()),
        status: $("#summaryStatus").val(),
        academic_performance: $("#academicPerformance").val(),
        strengths: $("#strengths").val(),
        areas_for_improvement: $("#areasForImprovement").val(),
        recommendations: $("#recommendations").val(),
        additional_comments: $("#additionalComments").val(),
      };

      $.ajax({
        url: "/teacher/api/progress-summaries",
        method: "POST",
        contentType: "application/json",
        data: JSON.stringify(formData),
        success: function (response) {
          $("#createSummaryModal").modal("hide");
          $("#createSummaryForm")[0].reset();
          loadSummaries();
          showToast("Progress summary saved successfully!", "success");
        },
        error: function (xhr) {
          const error =
            xhr.responseJSON?.error || "Failed to save progress summary";
          showToast(error, "error");
        },
      });
    });

    // Filter functionality
    $("#classFilter, #pupilFilter").on("change", function () {
      loadSummaries();
    });

    function loadTerms() {
      $.ajax({
        url: "/teacher/api/terms",
        method: "GET",
        success: function (data) {
          const termSelect = $("#summaryTerm");
          termSelect.empty();
          termSelect.append('<option value="">Select Term</option>');

          data.forEach(function (term) {
            termSelect.append(
              `<option value="${term.id}">${term.name} (${term.academic_year})</option>`
            );
          });
        },
      });
    }

    function loadSummaries() {
      const filters = {
        class_id: $("#classFilter").val(),
        pupil_id: $("#pupilFilter").val(),
      };

      $.ajax({
        url: "/teacher/api/progress-summaries",
        method: "GET",
        data: filters,
        success: function (data) {
          const tbody = $("#summariesTable tbody");
          tbody.empty();

          if (data.length === 0) {
            tbody.append(
              '<tr><td colspan="8" class="text-center">No progress summaries found</td></tr>'
            );
            return;
          }

          data.forEach(function (summary) {
            const statusBadge = getStatusBadge(summary.status);
            const gradeBadge = getGradeBadge(summary.overall_grade);
            const row = `
                        <tr>
                            <td>${summary.pupil_name}</td>
                            <td>${summary.class_name}</td>
                            <td>${summary.term_name}</td>
                            <td>${gradeBadge}</td>
                            <td>${summary.attendance_percentage}%</td>
                            <td>${statusBadge}</td>
                            <td>${summary.created_at}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary me-1" onclick="viewSummary(${summary.id})">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-warning me-1" onclick="editSummary(${summary.id})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-info me-1" onclick="printSummary(${summary.id})">
                                    <i class="fas fa-print"></i>
                                </button>
                            </td>
                        </tr>
                    `;
            tbody.append(row);
          });
        },
        error: function () {
          showToast("Failed to load progress summaries", "error");
        },
      });
    }

    function getStatusBadge(status) {
      const badges = {
        excellent: '<span class="badge bg-success">Excellent</span>',
        good: '<span class="badge bg-primary">Good</span>',
        satisfactory: '<span class="badge bg-info">Satisfactory</span>',
        needs_improvement:
          '<span class="badge bg-warning">Needs Improvement</span>',
        concern: '<span class="badge bg-danger">Concern</span>',
      };
      return (
        badges[status] || '<span class="badge bg-secondary">Unknown</span>'
      );
    }

    function getGradeBadge(grade) {
      const badges = {
        A: '<span class="badge bg-success">A</span>',
        B: '<span class="badge bg-primary">B</span>',
        C: '<span class="badge bg-info">C</span>',
        D: '<span class="badge bg-warning">D</span>',
        E: '<span class="badge bg-danger">E</span>',
        F: '<span class="badge bg-dark">F</span>',
      };
      return badges[grade] || '<span class="badge bg-secondary">-</span>';
    }

    window.clearFilters = function () {
      $("#classFilter, #pupilFilter").val("");
      loadSummaries();
    };

    window.viewSummary = function (id) {
      // TODO: Implement view summary details
      showToast("View summary functionality coming soon!", "info");
    };

    window.editSummary = function (id) {
      // TODO: Implement edit summary
      showToast("Edit summary functionality coming soon!", "info");
    };

    window.printSummary = function (id) {
      // TODO: Implement print summary
      showToast("Print summary functionality coming soon!", "info");
    };
  });
</script>
{% endblock %}

