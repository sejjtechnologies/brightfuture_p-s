<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
    />
    <style>
      @media (max-width: 768px) {
        .btn-close {
          font-size: 0.6em !important;
        }
      }
      /* Make icons and text perfectly vertically centered */
      .btn i {
        vertical-align: middle;
        margin-right: 5px; /* space between icon and text */
      }
      .staff-btn {
        width: 140px;
      }
      .class-btn {
        width: 140px;
      }
      .sidebar-button:hover {
        background: #f0f0f0 !important;
      }
      .sidebar-section {
        margin-bottom: 20px;
      }
      .sidebar-item {
        cursor: pointer;
        padding: 5px 10px;
        font-weight: bold;
        color: #ffff00;
        text-transform: uppercase;
        font-size: 0.7em;
        border-bottom: 1px solid rgba(255, 255, 255, 0.3);
      }
      .sidebar-item i {
        color: #333;
      }
      .sidebar-item:hover {
        background: rgba(255, 255, 255, 0.2);
      }
      .sidebar-subitem {
        display: flex;
        align-items: center;
        cursor: pointer;
        padding: 3px 10px 3px 5px;
        color: white;
        font-size: 0.75em;
        white-space: nowrap;
      }
      .sidebar-subitem:hover {
        background: rgba(255, 255, 255, 0.2);
      }
      .vertical-icon {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        gap: 4px;
      }
      .sidebar-item.vertical-icon i {
        font-size: 1.5em;
      }
      @media (max-width: 767px) {
        .sidebar-item {
          font-size: 0.6em;
          padding: 3px 8px;
        }
        .sidebar-subitem {
          font-size: 0.65em;
          padding: 2px 10px 2px 5px;
          white-space: nowrap;
        }
      }
      @media (min-width: 768px) {
        .responsive-btn {
          font-size: 0.8em;
          padding: 0.2rem 0.4rem;
        }
      }
    </style>
  </head>
  <body>
    <div class="container-fluid">
      <div class="row">
        <div
          id="sidebar"
          class="bg-primary"
          style="
            height: 100vh;
            background-color: #00008b !important;
            position: fixed;
            padding-top: 2px;
            z-index: 1000;
            overflow-y: auto;
            overflow-x: hidden;
            width: 205px !important;
          "
        >
          <button
            class="btn-close"
            style="position: absolute; top: 15px; right: 10px; font-size: 0.8em"
            onclick="hideSidebar()"
          ></button>
          <div class="d-flex flex14column h-100">
            <div style="padding-top: 30px; padding-bottom: 30px">
              <div
                class="d-flex flex-column align-items-start"
                style="gap: 0.5rem; padding-left: 10px"
              >
                <div
                  class="sidebar-item vertical-icon"
                  onclick="showDashboard()"
                >
                  <i
                    class="bi bi-house"
                    style="color: #28a745; font-size: 2em"
                  ></i>
                  <span>Dashboard</span>
                </div>
                <div class="sidebar-section">
                  <div class="sidebar-item vertical-icon">
                    <i class="bi bi-person-badge" style="color: #007bff"></i>
                    <span>Staff & Role Management</span>
                  </div>
                  <div
                    class="sidebar-subitem"
                    onclick="loadContent('{{ url_for('admin.create_staff') }}')"
                  >
                    <i
                      class="bi bi-person-plus me-2"
                      style="color: #28a745"
                    ></i>
                    Create Staff
                  </div>
                  <div
                    class="sidebar-subitem"
                    onclick="loadContent('{{ url_for('admin.manage_users') }}')"
                  >
                    <i class="bi bi-people me-2" style="color: #28a745"></i>
                    Manage Users
                  </div>
                </div>
                <div class="sidebar-section">
                  <div class="sidebar-item vertical-icon">
                    <i class="bi bi-journal" style="color: #28a745"></i>
                    <span>Academic Setup & Assignments</span>
                  </div>
                  <div
                    class="sidebar-subitem"
                    onclick="loadContent('{{ url_for('admin.create_class') }}')"
                  >
                    <i class="bi bi-book me-2" style="color: #28a745"></i>
                    Create Class
                  </div>
                  <div
                    class="sidebar-subitem"
                    onclick="loadContent('{{ url_for('admin.manage_classes') }}')"
                  >
                    <i class="bi bi-list me-2" style="color: #28a745"></i>
                    Manage Classes
                  </div>
                  <div
                    class="sidebar-subitem"
                    onclick="loadContent('{{ url_for('admin.create_subject') }}')"
                  >
                    <i
                      class="bi bi-file-earmark-plus me-2"
                      style="color: #28a745"
                    ></i>
                    Create Subject
                  </div>
                  <div
                    class="sidebar-subitem"
                    onclick="loadContent('{{ url_for('admin.manage_subjects') }}')"
                  >
                    <i class="bi bi-list me-2" style="color: #28a745"></i>
                    Manage Subjects
                  </div>
                  <div
                    class="sidebar-subitem"
                    onclick="loadContent('{{ url_for('admin.create_stream') }}')"
                  >
                    <i class="bi bi-diagram-3 me-2" style="color: #28a745"></i>
                    Create Stream
                  </div>
                  <div
                    class="sidebar-subitem"
                    onclick="loadContent('{{ url_for('admin.manage_streams') }}')"
                  >
                    <i class="bi bi-list me-2" style="color: #28a745"></i>
                    Manage Streams
                  </div>
                  <div
                    class="sidebar-subitem"
                    onclick="loadContent('{{ url_for('admin.assign_teachers') }}')"
                  >
                    <i
                      class="bi bi-person-check me-2"
                      style="color: #28a745"
                    ></i>
                    Assign Teachers
                  </div>
                  <div
                    class="sidebar-subitem"
                    onclick="loadContent('{{ url_for('admin.manage_assignments') }}')"
                  >
                    <i class="bi bi-gear me-2" style="color: #28a745"></i>
                    Manage Assignments
                  </div>
                </div>
                <div class="sidebar-section">
                  <div class="sidebar-item vertical-icon">
                    <i class="bi bi-calendar-week" style="color: #fd7e14"></i>
                    <span>Academic Management</span>
                  </div>
                  <div
                    class="sidebar-subitem"
                    onclick="loadContent('{{ url_for('admin.create_academic_year') }}')"
                  >
                    <i
                      class="bi bi-calendar-plus me-2"
                      style="color: #28a745"
                    ></i>
                    Create Academic Year
                  </div>
                  <div
                    class="sidebar-subitem"
                    onclick="loadContent('{{ url_for('admin.manage_academic_years') }}')"
                  >
                    <i class="bi bi-list me-2" style="color: #28a745"></i>
                    Manage Academic Years
                  </div>
                  <div
                    class="sidebar-subitem"
                    onclick="loadContent('{{ url_for('admin.create_term') }}')"
                  >
                    <i
                      class="bi bi-calendar2-plus me-2"
                      style="color: #28a745"
                    ></i>
                    Create Term
                  </div>
                  <div
                    class="sidebar-subitem"
                    onclick="loadContent('{{ url_for('admin.manage_terms') }}')"
                  >
                    <i class="bi bi-list me-2" style="color: #28a745"></i>
                    Manage Terms
                  </div>
                  <div
                    class="sidebar-subitem"
                    onclick="loadContent('{{ url_for('admin.set_current_term_year') }}')"
                  >
                    <i class="bi bi-gear me-2" style="color: #28a745"></i>
                    Set Current Term Year
                  </div>
                </div>
                <div class="sidebar-section">
                  <div class="sidebar-item vertical-icon">
                    <i class="bi bi-clipboard-data" style="color: #dc3545"></i>
                    <span>Exam Management</span>
                  </div>
                  <div
                    class="sidebar-subitem"
                    onclick="loadContent('{{ url_for('admin.create_exam_schedule') }}')"
                  >
                    <i
                      class="bi bi-calendar-event me-2"
                      style="color: #28a745"
                    ></i>
                    Create Exam Schedule
                  </div>
                  <div
                    class="sidebar-subitem"
                    onclick="loadContent('{{ url_for('admin.manage_exam_schedules') }}')"
                  >
                    <i class="bi bi-list me-2" style="color: #28a745"></i>
                    Manage Exam Schedules
                  </div>
                </div>
                <div class="sidebar-section">
                  <div class="sidebar-item vertical-icon">
                    <i class="bi bi-bell-fill" style="color: #6f42c1"></i>
                    <span>Notifications</span>
                  </div>
                  <div
                    class="sidebar-subitem"
                    onclick="loadContent('{{ url_for('admin.create_notification') }}')"
                  >
                    <i
                      class="bi bi-plus-circle me-2"
                      style="color: #28a745"
                    ></i>
                    Create Notification
                  </div>
                  <div
                    class="sidebar-subitem"
                    onclick="loadContent('{{ url_for('admin.manage_notifications') }}')"
                  >
                    <i class="bi bi-list me-2" style="color: #28a745"></i>
                    Manage Notifications
                  </div>
                </div>
                <div
                  class="sidebar-item"
                  onclick="loadContent('{{ url_for('admin.system_settings') }}')"
                  style="text-transform: none"
                >
                  <i class="bi bi-gear-fill me-2" style="color: white"></i>
                  System settings
                </div>
                <div class="sidebar-item" style="text-transform: none">
                  <i class="bi bi-bar-chart-fill me-2" style="color: white"></i>
                  School-wide reporting
                </div>
              </div>
            </div>
          </div>
        </div>
        <div
          class="col-12 col-md-10 offset-md-2"
          style="
            position: relative;
            min-height: 100vh;
            padding-bottom: 80px;
            margin-left: 205px;
            padding-top: 100px;
          "
        >
          <button
            id="showBtn"
            style="
              position: absolute;
              top: 0;
              left: 0;
              font-size: 0.8em;
              background: white;
              border: 1px solid black;
              color: black;
              font-weight: bold;
              display: none;
            "
            onclick="showSidebar()"
          >
            <i class="bi bi-chevron-left"></i>
          </button>
          <div class="container" style="margin-top: 1px">
            <div
              class="card"
              style="
                background-color: lightgreen;
                height: 80px;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                position: fixed;
                top: 20px;
                left: 35%;
                width: 50%;
                z-index: 999;
              "
            >
              <div
                class="card-body d-flex flex-column justify-content-center align-items-center text-center position-relative"
              >
                <a
                  href="/auth/logout"
                  class="btn"
                  style="
                    position: fixed;
                    left: 37%;
                    top: 50px;
                    background: white;
                    color: red;
                    border: 1px solid red;
                    text-decoration: none;
                    font-weight: bold;
                    font-size: 0.75em;
                    padding: 4px 8px;
                    height: 28px;
                    display: flex;
                    align-items: center;
                    z-index: 1001;
                  "
                  ><i class="bi bi-power me-1" style="font-size: 1em"></i>
                  Logout</a
                >
                <h5 style="color: blue; font-weight: bold; margin: 0">
                  Welcome Admin
                </h5>
                {% if term_progress %}
                <p style="color: darkgreen; font-size: 0.8em; margin: 2px 0">
                  {{ term_progress.term_name }} ({{
                  term_progress.academic_year_name }}) - Term {{
                  term_progress.current_term_number }} of {{
                  term_progress.total_terms_in_year }}
                </p>
                <p style="color: darkgreen; font-size: 0.7em; margin: 0">
                  Days spent: {{ term_progress.days_spent }} | Remaining: {{
                  term_progress.days_remaining }}
                </p>
                {% else %}
                <p
                  style="
                    color: darkgreen;
                    font-size: 0.9em;
                    margin: 0;
                    margin-top: 5px;
                  "
                >
                  Manage your school system efficiently
                </p>
                {% endif %}
              </div>
            </div>

            <div
              id="main-content"
              style="
                margin-top: 10px;
                margin-left: 180px;
                max-height: calc(100vh - 120px);
                overflow-y: auto;
                overflow-x: auto;
                padding: 0 2px;
              "
            >
              {% block content %}{% endblock %}
            </div>
            <div
              id="loading-indicator"
              style="
                display: none;
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
              "
            >
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <script>
      function hideSidebar() {
        document.getElementById("sidebar").style.display = "none";
        document.getElementById("showBtn").style.display = "block";
      }
      function showSidebar() {
        document.getElementById("sidebar").style.display = "block";
        document.getElementById("showBtn").style.display = "none";
      }
      function toggleStaffButtons() {
        // Always hide iframe
        const iframe = document.getElementById("content-frame");
        if (iframe) iframe.style.display = "none";
        const staffButtons = document.getElementById("staff-buttons");
        if (!staffButtons) return;
        if (staffButtons.style.display === "flex") {
          staffButtons.style.setProperty("display", "none", "important");
        } else {
          staffButtons.style.setProperty("display", "flex", "important");
          // Hide class buttons
          const classButtons = document.getElementById("class-buttons");
          if (classButtons) classButtons.style.display = "none";
          // Hide academic buttons
          const academicButtons = document.getElementById("academic-buttons");
          if (academicButtons) academicButtons.style.display = "none";
          // Hide notification buttons
          const notificationButtons = document.getElementById(
            "notification-buttons"
          );
          if (notificationButtons) notificationButtons.style.display = "none";
        }
      }
      function toggleClassButtons() {
        console.log("toggleClassButtons called");
        // Always hide iframe
        const iframe = document.getElementById("content-frame");
        if (iframe) iframe.style.display = "none";
        const classButtons = document.getElementById("class-buttons");
        if (!classButtons) return;
        if (classButtons.style.display === "flex") {
          classButtons.style.display = "none";
        } else {
          classButtons.style.display = "flex";
          // Hide staff buttons
          const staffButtons = document.getElementById("staff-buttons");
          if (staffButtons)
            staffButtons.style.setProperty("display", "none", "important");
          // Hide academic buttons
          const academicButtons = document.getElementById("academic-buttons");
          if (academicButtons) academicButtons.style.display = "none";
          // Hide notification buttons
          const notificationButtons = document.getElementById(
            "notification-buttons"
          );
          if (notificationButtons) notificationButtons.style.display = "none";
        }
      }
      function toggleAcademicButtons() {
        // Always hide iframe
        const iframe = document.getElementById("content-frame");
        if (iframe) iframe.style.display = "none";
        const academicButtons = document.getElementById("academic-buttons");
        if (!academicButtons) return;
        if (academicButtons.style.display === "flex") {
          academicButtons.style.display = "none";
        } else {
          academicButtons.style.display = "flex";
          // Hide staff buttons
          const staffButtons = document.getElementById("staff-buttons");
          if (staffButtons)
            staffButtons.style.setProperty("display", "none", "important");
          // Hide class buttons
          const classButtons = document.getElementById("class-buttons");
          if (classButtons) classButtons.style.display = "none";
          // Hide notification buttons
          const notificationButtons = document.getElementById(
            "notification-buttons"
          );
          if (notificationButtons) notificationButtons.style.display = "none";
        }
      }
      function toggleNotificationButtons() {
        // Always hide iframe
        const iframe = document.getElementById("content-frame");
        if (iframe) iframe.style.display = "none";
        const notificationButtons = document.getElementById(
          "notification-buttons"
        );
        if (!notificationButtons) return;
        if (notificationButtons.style.display === "flex") {
          notificationButtons.style.display = "none";
        } else {
          notificationButtons.style.display = "flex";
          // Hide staff buttons
          const staffButtons = document.getElementById("staff-buttons");
          if (staffButtons)
            staffButtons.style.setProperty("display", "none", "important");
          // Hide class buttons
          const classButtons = document.getElementById("class-buttons");
          if (classButtons) classButtons.style.display = "none";
          // Hide academic buttons
          const academicButtons = document.getElementById("academic-buttons");
          if (academicButtons) academicButtons.style.display = "none";
        }
      }
      function hideLoading() {
        const loading = document.getElementById("loading-indicator");
        if (loading) loading.style.display = "none";
      }
      function loadContent(url) {
        const mainContent = document.getElementById("main-content");
        const loading = document.getElementById("loading-indicator");
        if (loading) loading.style.display = "block";
        fetch(url, {
          headers: {
            "X-Requested-With": "XMLHttpRequest",
          },
        })
          .then((response) => response.text())
          .then((html) => {
            // Parse the HTML to extract only the main content
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, "text/html");

            // Find the main-content div in the loaded page
            const loadedMainContent = doc.getElementById("main-content");
            if (loadedMainContent) {
              // Use only the content inside the main-content div
              mainContent.innerHTML = loadedMainContent.innerHTML;
            } else {
              // Fallback: use the entire HTML
              mainContent.innerHTML = html;
            }

            // Execute any scripts in the loaded content
            const scripts = mainContent.querySelectorAll("script");
            scripts.forEach((script) => {
              if (script.src) {
                // External script
                const newScript = document.createElement("script");
                newScript.src = script.src;
                document.head.appendChild(newScript);
              } else {
                // Inline script
                const newScript = document.createElement("script");
                newScript.textContent = script.textContent;
                document.body.appendChild(newScript);
              }
            });

            if (loading) loading.style.display = "none";
          })
          .catch((error) => {
            console.error("Error loading content:", error);
            if (loading) loading.style.display = "none";
          });
        // Keep sidebar visible
        const sidebar = document.getElementById("sidebar");
        if (sidebar) sidebar.style.display = "block";
        const showBtn = document.getElementById("showBtn");
        if (showBtn) showBtn.style.display = "none";
      }
      function showDashboard() {
        const mainContent = document.getElementById("main-content");
        if (mainContent)
          mainContent.innerHTML = "<h1 class='text-center mt-5'>Dashboard</h1>";
        // Show sidebar back
        const sidebar = document.getElementById("sidebar");
        if (sidebar) sidebar.style.display = "block";
        const showBtn = document.getElementById("showBtn");
        if (showBtn) showBtn.style.display = "none";
      }
      // Hide flash message after 2 seconds
      setTimeout(() => {
        const flash = document.getElementById("flash-message");
        if (flash) flash.style.display = "none";
      }, 2000);

      window.editRow = function (id) {
        // Hide display spans and show inputs/selects
        document.getElementById(`title-display-${id}`).classList.add("d-none");
        document.getElementById(`title-input-${id}`).classList.remove("d-none");
        document
          .getElementById(`message-display-${id}`)
          .classList.add("d-none");
        document
          .getElementById(`message-input-${id}`)
          .classList.remove("d-none");
        document
          .getElementById(`visibility-display-${id}`)
          .classList.add("d-none");
        document
          .getElementById(`visibility-input-${id}`)
          .classList.remove("d-none");

        // Hide edit button, show save and cancel buttons
        document.getElementById(`edit-btn-${id}`).classList.add("d-none");
        document.getElementById(`save-btn-${id}`).classList.remove("d-none");
        document.getElementById(`cancel-btn-${id}`).classList.remove("d-none");
      };

      window.cancelEdit = function (id) {
        // Show display spans and hide inputs/selects
        document
          .getElementById(`title-display-${id}`)
          .classList.remove("d-none");
        document.getElementById(`title-input-${id}`).classList.add("d-none");
        document
          .getElementById(`message-display-${id}`)
          .classList.remove("d-none");
        document.getElementById(`message-input-${id}`).classList.add("d-none");
        document
          .getElementById(`visibility-display-${id}`)
          .classList.remove("d-none");
        document
          .getElementById(`visibility-input-${id}`)
          .classList.add("d-none");

        // Show edit button, hide save and cancel buttons
        document.getElementById(`edit-btn-${id}`).classList.remove("d-none");
        document.getElementById(`save-btn-${id}`).classList.add("d-none");
        document.getElementById(`cancel-btn-${id}`).classList.add("d-none");
      };

      window.saveRow = function (id) {
        // Get values from inputs/selects
        const title = document.getElementById(`title-input-${id}`).value;
        const message = document.getElementById(`message-input-${id}`).value;
        const visibility = document.getElementById(
          `visibility-input-${id}`
        ).value;

        // Create a form and submit to refresh the page
        const form = document.createElement("form");
        form.method = "POST";
        form.action = "/admin/manage_notifications";
        form.style.display = "none";
        form.innerHTML = `
          <input name="notification_id" value="${id}">
          <input name="title" value="${title}">
          <input name="message" value="${message}">
          <input name="visibility" value="${visibility}">
        `;
        document.body.appendChild(form);
        form.submit();
      };

      window.deleteRow = function (id) {
        window.currentDeleteId = id;
        const modal = new bootstrap.Modal(
          document.getElementById("deleteModal")
        );
        modal.show();
      };

      window.setDeleteAction = function (id) {
        console.log("setDeleteAction called with id:", id);
        window.currentDeleteId = id;
      };

      window.confirmDelete = function () {
        // Check if this is a notification delete (has deleteModal)
        const modalElement = document.getElementById("deleteModal");
        if (modalElement) {
          const modal = bootstrap.Modal.getInstance(modalElement);
          if (modal) modal.hide();
          const id = window.currentDeleteId;
          fetch(`/admin/delete_notification/${id}`, {
            method: "POST",
            headers: {
              "X-Requested-With": "XMLHttpRequest",
            },
          })
            .then((response) => response.json())
            .then((data) => {
              // Clear existing flash
              const existingFlash = document.getElementById("flash-message");
              if (existingFlash) existingFlash.remove();

              const msgDiv = document.createElement("div");
              msgDiv.id = "flash-message";
              msgDiv.className = data.success
                ? "alert alert-success"
                : "alert alert-danger";
              msgDiv.textContent = data.message;
              document
                .querySelector(".card-body")
                .insertBefore(
                  msgDiv,
                  document.querySelector(".card-body").firstChild
                );

              if (data.success) {
                // Reload the page to apply updates immediately
                window.location.reload();
              }
            })
            .catch((error) => {
              console.error("Error:", error);
            });
        } else {
          // This is not a notification delete, management pages handle their own deletion
          console.log(
            "confirmDelete called but no deleteModal found - assuming management page handles deletion"
          );
        }
      };

      // Management page delete functions
      window.confirmDeleteClass = function () {
        if (window.currentDeleteId) {
          // Close the modal
          const modal = bootstrap.Modal.getInstance(
            document.getElementById("deleteClassModal")
          );
          if (modal) modal.hide();

          fetch(`/admin/delete_class/${window.currentDeleteId}`, {
            method: "POST",
          })
            .then((response) => {
              window.location.reload();
            })
            .catch((error) => {
              console.error("Error:", error);
            });
        }
      };

      window.confirmDeleteStream = function () {
        if (window.currentDeleteId) {
          // Close the modal
          const modal = bootstrap.Modal.getInstance(
            document.getElementById("deleteStreamModal")
          );
          if (modal) modal.hide();

          fetch(`/admin/delete_stream/${window.currentDeleteId}`, {
            method: "POST",
          })
            .then((response) => {
              window.location.reload();
            })
            .catch((error) => {
              console.error("Error:", error);
            });
        }
      };

      window.confirmDeleteSubject = function () {
        if (window.currentDeleteId) {
          // Close the modal
          const modal = bootstrap.Modal.getInstance(
            document.getElementById("deleteModal")
          );
          if (modal) modal.hide();

          fetch(`/admin/delete_subject/${window.currentDeleteId}`, {
            method: "POST",
          })
            .then((response) => {
              window.location.reload();
            })
            .catch((error) => {
              console.error("Error:", error);
            });
        }
      };

      window.confirmDeleteTerm = function () {
        if (window.currentDeleteId) {
          // Close the modal
          const modal = bootstrap.Modal.getInstance(
            document.getElementById("deleteModal")
          );
          if (modal) modal.hide();

          fetch(`/admin/delete_term/${window.currentDeleteId}`, {
            method: "POST",
          })
            .then((response) => {
              window.location.reload();
            })
            .catch((error) => {
              console.error("Error:", error);
            });
        }
      };

      window.confirmDeleteAcademicYear = function () {
        if (window.currentDeleteId) {
          // Close the modal
          const modal = bootstrap.Modal.getInstance(
            document.getElementById("deleteModal")
          );
          if (modal) modal.hide();

          fetch(`/admin/delete_academic_year/${window.currentDeleteId}`, {
            method: "POST",
          })
            .then((response) => {
              window.location.reload();
            })
            .catch((error) => {
              console.error("Error:", error);
            });
        }
      };

      window.confirmDeleteAssignment = function () {
        if (window.currentDeleteId) {
          // Close the modal
          const modal = bootstrap.Modal.getInstance(
            document.getElementById("deleteModal")
          );
          if (modal) modal.hide();

          fetch(`/admin/delete_assignment/${window.currentDeleteId}`, {
            method: "POST",
          })
            .then((response) => {
              window.location.reload();
            })
            .catch((error) => {
              console.error("Error:", error);
            });
        }
      };

      window.confirmDeleteUser = function () {
        console.log(
          "confirmDeleteUser called, currentDeleteId:",
          window.currentDeleteId
        );
        if (window.currentDeleteId) {
          // Close the modal
          const modalElement = document.getElementById("deleteUserModal");
          console.log("modalElement:", modalElement);
          const modal = modalElement
            ? bootstrap.Modal.getInstance(modalElement)
            : null;
          console.log("modal instance:", modal);
          if (modal) modal.hide();

          fetch(`/admin/delete_user/${window.currentDeleteId}`, {
            method: "POST",
          })
            .then((response) => {
              console.log("Fetch response:", response);
              window.location.reload();
            })
            .catch((error) => {
              console.error("Error:", error);
            });
        }
      };

      // Password toggle function
      window.togglePassword = function () {
        const passwordInput = document.getElementById("password");
        const toggleBtn = document.getElementById("togglePassword");
        if (passwordInput && toggleBtn) {
          const icon = toggleBtn.querySelector("i");
          if (passwordInput.type === "password") {
            passwordInput.type = "text";
            if (icon) {
              icon.classList.remove("bi-eye");
              icon.classList.add("bi-eye-slash");
            }
          } else {
            passwordInput.type = "password";
            if (icon) {
              icon.classList.remove("bi-eye-slash");
              icon.classList.add("bi-eye");
            }
          }
        }
      };

      // Username capitalization function
      window.capitalizeUsername = function () {
        const usernameInput = document.getElementById("username");
        if (usernameInput) {
          usernameInput.addEventListener("input", function () {
            this.value =
              this.value.charAt(0).toUpperCase() +
              this.value.slice(1).toLowerCase();
          });
        }
      };

      // Form validation function
      window.setupFormValidation = function () {
        const form = document.getElementById("createStaffForm");
        if (form) {
          form.addEventListener("submit", function (event) {
            const password = document.getElementById("password").value;
            const warning = document.getElementById("passwordWarning");
            const minLength = 8; // Default, or get from template if needed

            if (password && password.length < minLength) {
              event.preventDefault(); // Prevent form submission
              if (warning) {
                warning.textContent = `Password must be at least ${minLength} characters long.`;
                warning.style.display = "block";
              }
              document.getElementById("password").focus();
            } else {
              if (warning) warning.style.display = "none";
            }
          });
        }
      };

      // User management functions
      window.editRow = function (btn) {
        const row = btn.closest("tr");
        const inputs = row.querySelectorAll(".editable");
        inputs.forEach((input) => {
          input.removeAttribute("readonly");
          input.removeAttribute("disabled");
        });
        const toggleBtn = row.querySelector(".toggle-password");
        if (toggleBtn) toggleBtn.style.display = "inline-block";
        const passwordInput = row.querySelector(".password-container input");
        const saveBtn = row.querySelector(".save-btn");
        if (saveBtn) saveBtn.disabled = false; // Enable initially since password is empty (not tampered)
        if (passwordInput) {
          passwordInput.addEventListener("input", function () {
            const warning = row.querySelector(".password-warning");
            const saveBtn = row.querySelector(".save-btn");
            if (this.value && this.value.length < 8) {
              if (warning) {
                warning.textContent = "Password must be at least 8 characters";
                warning.style.display = "block";
              }
              if (saveBtn) saveBtn.disabled = true;
            } else {
              if (warning) warning.style.display = "none";
              if (saveBtn) saveBtn.disabled = false;
            }
          });
        }
        btn.style.display = "none";
        if (saveBtn) saveBtn.style.display = "inline-block";
      };

      window.saveRow = function (btn) {
        const row = btn.closest("tr");
        const userId = row.dataset.userId;
        const username = row.querySelector('input[type="text"]').value;
        const email = row.querySelector('input[type="email"]').value;
        const password = row.querySelector(".password-container input").value;
        const roleId = row.querySelector("select").value;

        // Password validation
        const minLength = 8;
        const passwordWarning = row.querySelector(".password-warning");
        if (password && password.length < minLength) {
          if (passwordWarning) {
            passwordWarning.textContent = `Password must be at least ${minLength} characters long.`;
            passwordWarning.style.display = "block";
          }
          row.querySelector(".password-container input").focus();
          return;
        } else {
          if (passwordWarning) passwordWarning.style.display = "none";
        }

        // Create form and submit
        const form = document.createElement("form");
        form.method = "POST";
        form.action = "/admin/manage_users";

        const fields = [
          { name: "user_id", value: userId },
          { name: "username", value: username },
          { name: "email", value: email },
          { name: "password", value: password },
          { name: "role_id", value: roleId },
        ];

        fields.forEach((field) => {
          const input = document.createElement("input");
          input.type = "hidden";
          input.name = field.name;
          input.value = field.value;
          form.appendChild(input);
        });

        document.body.appendChild(form);
        form.submit();
      };

      window.showDeleteModal = function (userId) {
        const modal = new bootstrap.Modal(
          document.getElementById("deleteUserModal")
        );
        const deleteForm = document.getElementById("deleteUserForm");
        if (deleteForm) {
          deleteForm.action = `/admin/delete_user/${userId}`;
        }
        modal.show();
      };

      // Global function for setting delete form actions in AJAX-loaded content
      window.setDeleteAction = function (id) {
        // This function will be overridden by local functions in each template
        // but provides a fallback
        console.log("setDeleteAction called with id:", id);
        window.currentDeleteId = id;
      };

      window.togglePassword = function (btn) {
        const container = btn.closest(".password-container");
        const input = container.querySelector(
          'input[type="password"], input[type="text"]'
        );
        if (input.type === "password") {
          input.type = "text";
          btn.textContent = "Hide";
        } else {
          input.type = "password";
          btn.textContent = "Show";
        }
      };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    {% include 'welcome_modal.html' %} {% include 'footer.html' %}
  </body>
</html>
