{% extends "admin/dashboard.html" %} {% block title %}Manage Users - Admin
Dashboard{% endblock %} {% block content %}
<div class="row">
  <div class="col-12">
    <div class="card" style="margin-left: -15px; margin-right: -15px">
      <div class="card-header">
        <h5 class="mb-0">Manage Users</h5>
      </div>
      <div class="card-body">
        {% with messages = get_flashed_messages() %} {% if messages %}
        <div id="flash-message" class="alert alert-info" role="alert">
          {% for message in messages %} {{ message }} {% endfor %}
        </div>
        {% endif %} {% endwith %}

        <!-- Search Bar -->
        <div class="d-flex justify-content-center mb-3">
          <div class="input-group" style="width: 100%; max-width: 100%">
            <span class="input-group-text"><i class="bi bi-search"></i></span>
            <input
              type="text"
              class="form-control"
              id="userSearch"
              placeholder="Search users by ID, username, email, or role..."
              style="font-size: 0.9em"
            />
            <button
              class="btn btn-outline-secondary"
              type="button"
              onclick="clearSearch()"
              title="Clear search"
            >
              <i class="bi bi-x"></i>
            </button>
          </div>
        </div>

        <table
          class="table table-striped table-hover"
          style="table-layout: fixed; width: 100%; overflow-x: hidden"
        >
          <thead>
            <tr>
              <th style="width: 5%">ID</th>
              <th style="width: 15%">Username</th>
              <th style="width: 25%">Email</th>
              <th style="width: 10%">Role</th>
              <th style="width: 15%">Last Login</th>
              <th style="width: 15%">Created At</th>
              <th style="width: 15%">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for user in users %}
            <tr>
              <td>{{ user.id }}</td>
              <td style="word-break: break-all">{{ user.username }}</td>
              <td style="word-break: break-all">{{ user.email or 'N/A' }}</td>
              <td>{{ user.role.name }}</td>
              <td style="font-size: 0.85em">{{ user.last_login_kampala }}</td>
              <td style="font-size: 0.85em">{{ user.created_at_kampala }}</td>
              <td>
                <div class="btn-group btn-group-sm" role="group">
                  <button
                    class="btn btn-sm btn-outline-primary"
                    onclick="editUser({{ user.id }}, '{{ user.username }}', '{{ user.email }}', {{ user.role_id }})"
                    title="Edit User"
                  >
                    <i class="bi bi-pencil"></i>
                  </button>
                  <button
                    class="btn btn-sm btn-outline-danger"
                    onclick="deleteUser({{ user.id }}, '{{ user.username }}')"
                    title="Delete User"
                  >
                    <i class="bi bi-trash"></i>
                  </button>
                </div>
              </td>
            </tr>
            {% endfor %} {% if not users %}
            <tr>
              <td colspan="7" class="text-center">No users found</td>
            </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Edit User Modal -->
<div class="modal fade" id="editUserModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit User</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body">
        <form
          id="editUserForm"
          method="POST"
          action="{{ url_for('admin.manage_users') }}"
        >
          <input type="hidden" id="editUserId" name="user_id" />
          <div class="mb-3">
            <label for="editUsername" class="form-label">Username</label>
            <input
              type="text"
              class="form-control"
              id="editUsername"
              name="username"
              required
            />
          </div>
          <div class="mb-3">
            <label for="editEmail" class="form-label">Email</label>
            <input
              type="email"
              class="form-control"
              id="editEmail"
              name="email"
            />
          </div>
          <div class="mb-3">
            <label for="editRole" class="form-label">Role</label>
            <select class="form-select" id="editRole" name="role_id" required>
              {% for role in roles %}
              <option value="{{ role.id }}">{{ role.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-3">
            <label for="editPassword" class="form-label"
              >New Password (leave blank to keep current)</label
            >
            <div class="input-group">
              <input
                type="password"
                class="form-control"
                id="editPassword"
                name="password"
                minlength="{{ min_password_length }}"
              />
              <button
                class="btn btn-outline-secondary"
                type="button"
                onclick="togglePasswordVisibility()"
              >
                <i class="bi bi-eye" id="passwordIcon"></i>
              </button>
            </div>
            <div class="form-text">
              Minimum {{ min_password_length }} characters
            </div>
          </div>
          <button type="submit" class="btn btn-primary">Update User</button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
  function editUser(userId, username, email, roleId) {
    document.getElementById("editUserId").value = userId;
    document.getElementById("editUsername").value = username;
    document.getElementById("editEmail").value = email;
    document.getElementById("editRole").value = roleId;
    document.getElementById("editPassword").value = "";
    new bootstrap.Modal(document.getElementById("editUserModal")).show();
  }

  function deleteUser(userId, username) {
    if (confirm(`Are you sure you want to delete user "${username}"?`)) {
      const form = document.createElement("form");
      form.method = "POST";
      form.action = `/admin/delete_user/${userId}`;

      const csrfToken = document.querySelector('input[name="csrf_token"]');
      if (csrfToken) {
        const csrfInput = document.createElement("input");
        csrfInput.type = "hidden";
        csrfInput.name = "csrf_token";
        csrfInput.value = csrfToken.value;
        form.appendChild(csrfInput);
      }

      document.body.appendChild(form);
      form.submit();
    }
  }

  function togglePasswordVisibility() {
    const passwordInput = document.getElementById("editPassword");
    const icon = document.getElementById("passwordIcon");

    if (passwordInput.type === "password") {
      passwordInput.type = "text";
      icon.className = "bi bi-eye-slash";
    } else {
      passwordInput.type = "password";
      icon.className = "bi bi-eye";
    }
  }

  // Auto-hide flash messages
  setTimeout(function () {
    const flashMessage = document.getElementById("flash-message");
    if (flashMessage) {
      flashMessage.style.display = "none";
    }
  }, 5000);

  // Search functionality
  document.getElementById("userSearch").addEventListener("input", function () {
    filterUsers(this.value.toLowerCase());
  });

  function filterUsers(searchTerm) {
    const table = document.querySelector("table");
    const rows = table.querySelectorAll("tbody tr");
    let visibleCount = 0;

    rows.forEach((row) => {
      if (
        row.cells.length === 1 &&
        row.textContent.includes("No users found")
      ) {
        return; // Skip the "no users found" row
      }

      const cells = row.querySelectorAll("td");
      let match = false;

      // Search through all cells except the Actions column (last cell)
      for (let i = 0; i < cells.length - 1; i++) {
        const cellText = cells[i].textContent.toLowerCase();
        if (cellText.includes(searchTerm)) {
          match = true;
          break;
        }
      }

      if (match) {
        row.style.display = "";
        visibleCount++;
      } else {
        row.style.display = "none";
      }
    });

    // Update or show "no results" message
    updateNoResultsMessage(visibleCount, searchTerm);
  }

  function updateNoResultsMessage(visibleCount, searchTerm) {
    const tbody = document.querySelector("tbody");
    let noResultsRow = tbody.querySelector(".no-results-row");

    // Remove existing no results row
    if (noResultsRow) {
      noResultsRow.remove();
    }

    // Add no results row if no matches and search term exists
    if (visibleCount === 0 && searchTerm.trim() !== "") {
      noResultsRow = document.createElement("tr");
      noResultsRow.className = "no-results-row";
      noResultsRow.innerHTML = `<td colspan="7" class="text-center text-muted">No users found matching "${searchTerm}"</td>`;
      tbody.appendChild(noResultsRow);
    }
  }

  function clearSearch() {
    document.getElementById("userSearch").value = "";
    filterUsers("");
  }

  // Add keyboard shortcut for clearing search (Escape key)
  document.addEventListener("keydown", function (e) {
    if (e.key === "Escape" && document.activeElement.id === "userSearch") {
      clearSearch();
    }
  });
</script>
{% endblock %}
