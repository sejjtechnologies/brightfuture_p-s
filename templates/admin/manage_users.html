<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-center align-items-center mt-3 mb-4">
        <h2 style="font-size: 2.5rem;">Manage Users</h2>
      </div>

      {% with messages = get_flashed_messages() %}
      {% if messages %}
      <div id="flash-message" class="alert alert-info" role="alert">
        {% for message in messages %} {{ message }} {% endfor %}
      </div>
      {% endif %}
      {% endwith %}

      <div class="form-container" style="max-width: 100%; margin: 0;">
        <div class="card" style="margin: 0;">
              <div class="card-body" style="padding: 0;">
            <style>
              #main-content {
                padding: 0 !important;
              }
              .col-12 {
                padding-left: 0 !important;
                padding-right: 0 !important;
              }
              .table-wrapper {
                width: 100%;
                overflow-x: auto;
              }

              .stable-grid-table {
                width: 100%;
                table-layout: fixed;
                border-collapse: collapse;
                font-size: 0.95rem;
              }

              .stable-grid-table th,
              .stable-grid-table td {
                padding: 0.75rem;
                vertical-align: middle;
                white-space: nowrap;
              }

              .stable-grid-table thead th {
                background-color: #212529;
                color: #fff;
                position: sticky;
                top: 0;
                z-index: 2;
              }

              .stable-grid-table tbody tr:hover {
                background-color: #f8f9fa;
              }

              .stable-grid-table input,
              .stable-grid-table select {
                width: 100%;
                font-size: 0.9rem;
              }

              .action-buttons {
                display: flex;
                gap: 0.4rem;
                flex-wrap: wrap;
              }

              .stable-grid-table td:first-child {
                text-align: center;
                white-space: nowrap;
              }

              .action-buttons button {
                width: 50px;
                height: 30px;
                font-size: 0.8rem;
                padding: 0.2rem 0.4rem;
              }

              .stable-grid-table td:nth-child(6),
              .stable-grid-table td:nth-child(7) {
                font-size: 0.85rem;
              }
            </style>

            <div class="table-wrapper">
              <table class="stable-grid-table table table-bordered">
                <thead>
                  <tr>
                    <th style="width: 4%;">#</th>
                    <th style="width: 14%;">Username</th>
                    <th style="width: 16%;">Email</th>
                    <th style="width: 12%;">Password</th>
                    <th style="width: 12%;">Role</th>
                    <th style="width: 12%;">Last Login</th>
                    <th style="width: 12%;">Created At</th>
                    <th style="width: 18%;">Action</th>
                  </tr>
                </thead>

                <tbody>
                  {% for user in users %}
                  <tr data-user-id="{{ user.id }}">
                    <td>{{ user.display_id }}</td>

                    <td>
                      <input type="text"
                             class="form-control form-control-sm editable"
                             value="{{ user.username }}"
                             readonly>
                    </td>

                    <td>
                      <input type="email"
                             class="form-control form-control-sm editable"
                             value="{{ user.email }}"
                             readonly>
                    </td>

                    <td>
                      <div class="password-container">
                        <input type="password"
                               class="form-control form-control-sm editable"
                               placeholder="Leave blank to keep current"
                               readonly>
                        <button type="button" class="btn btn-sm btn-outline-secondary toggle-password" style="display: none;" onclick="togglePassword(this)">Show</button>
                      </div>
                      <div class="password-warning text-danger" style="display: none; font-size: 0.8em;">Password must be at least 8 characters</div>
                    </td>

                    <td>
                      <select class="form-select form-select-sm editable" disabled>
                        {% for role in roles %}
                        <option value="{{ role.id }}"
                          {% if role.id == user.role_id %}selected{% endif %}
                          {% if role.name == 'Admin' %}disabled{% endif %}>
                          {{ role.name }}
                        </option>
                        {% endfor %}
                      </select>
                    </td>

                    <td>{% if user.last_login_kampala != 'Never' %}{{ user.last_login_kampala.split(' ')[0] }}<br>{{ user.last_login_kampala.split(' ')[1] }}{% else %}{{ user.last_login_kampala }}{% endif %}</td>
                    <td>{% if user.created_at_kampala != 'N/A' %}{{ user.created_at_kampala.split(' ')[0] }}<br>{{ user.created_at_kampala.split(' ')[1] }}{% else %}{{ user.created_at_kampala }}{% endif %}</td>

                    <td>
                      <div class="action-buttons">
                        <button class="btn btn-sm btn-warning edit-btn"
                                onclick="editRow(this)"
                                {% if user.role.name == 'Admin' %}disabled{% endif %}>
                          Ed
                        </button>

                        <button class="btn btn-sm btn-success save-btn"
                                style="display:none;"
                                onclick="saveRow(this)">
                          Sv
                        </button>

                        <button class="btn btn-sm btn-danger"
                                data-bs-toggle="modal"
                                data-bs-target="#deleteUserModal"
                                onclick="setDeleteAction({{ user.id }})"
                                {% if user.role.name == 'Admin' %}disabled{% endif %}>
                          Del
                        </button>
                      </div>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>

            <div id="passwordWarning" class="alert alert-danger mt-2" style="display: none;"></div>

          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  setTimeout(() => {
    const flash = document.getElementById("flash-message");
    if (flash) flash.style.display = "none";
  }, 2000);

  function setDeleteAction(userId) {
    window.currentDeleteId = userId;
  }

  function confirmDeleteUser() {
    if (window.currentDeleteId) {
      const modalElement = document.getElementById("deleteUserModal");
      if (modalElement) {
        const modal = bootstrap.Modal.getInstance(modalElement);
        if (modal) modal.hide();
      }

      fetch(`/admin/delete_user/${window.currentDeleteId}`, {
        method: 'POST',
      }).then(() => {
        loadContent('{{ url_for('admin.manage_users') }}');
      }).catch(error => {
        console.error('Error:', error);
      });
    }
  }
</script>

<div class="modal fade" id="deleteUserModal" tabindex="-1" aria-labelledby="deleteUserModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteUserModalLabel">Confirm Deletion</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        Are you sure you want to delete this user? This action cannot be undone.
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" onclick="confirmDeleteUser()">Delete</button>
      </div>
    </div>
  </div>
</div>
