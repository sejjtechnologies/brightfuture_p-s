<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-center align-items-center mt-3 mb-4">
        <h2>Create Notification</h2>
      </div>
      <div class="form-container" style="max-width: 800px; margin: 0 auto;">
            {% with messages = get_flashed_messages() %} {% if messages %}
            <div id="flash-message" class="alert alert-info" role="alert">
              {% for message in messages %} {{ message }} {% endfor %}
            </div>
            {% endif %} {% endwith %}
            <div class="card" style="background-color: lightblue">
              <div class="card-body">
                <form
                  id="notificationForm"
                  method="POST"
                  action="{{ url_for('admin.create_notification') }}"
                >
                  <div
                    id="duplicate-warning"
                    class="alert alert-warning mb-3"
                    style="display: none"
                  ></div>
                  <div class="mb-3">
                    <label for="title" class="form-label">Title</label>
                    <div class="input-group">
                      <span class="input-group-text"
                        ><i class="bi bi-bell"></i
                      ></span>
                      <input
                        type="text"
                        class="form-control"
                        id="title"
                        name="title"
                        placeholder="e.g., School Holiday Announcement"
                        oninput="this.value = this.value.toLowerCase().replace(/\b\w/g, l => l.toUpperCase())"
                        required
                      />
                    </div>
                  </div>
                  <div class="mb-3">
                    <label for="message" class="form-label">Message</label>
                    <div class="input-group">
                      <span class="input-group-text"
                        ><i class="bi bi-chat-text"></i
                      ></span>
                      <textarea
                        class="form-control"
                        id="message"
                        name="message"
                        rows="5"
                        placeholder="Enter the notification message here..."
                        required
                      ></textarea>
                    </div>
                  </div>
                  <div class="mb-3">
                    <label for="visibility" class="form-label"
                      >Visibility</label
                    >
                    <div class="input-group">
                      <span class="input-group-text"
                        ><i class="bi bi-eye"></i
                      ></span>
                      <select
                        class="form-select"
                        id="visibility"
                        name="visibility"
                      >
                        <option value="all_except_parents_admins" selected>
                          All Users Except Parents and Admins
                        </option>
                        <option value="all">All Users</option>
                        {% for role in roles %}
                        <option value="{{ role.name.lower() }}_only">
                          {{ role.name }} Only
                        </option>
                        {% endfor %}
                      </select>
                    </div>
                  </div>
                  <div class="d-flex justify-content-center">
                    <button
                      id="submitBtn"
                      type="submit"
                      class="btn btn-success"
                    >
                      Create Notification
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <script>
      // Hide flash message after 2 seconds
      setTimeout(() => {
        const flash = document.getElementById("flash-message");
        if (flash) flash.style.display = "none";
      }, 2000);

      // Check for duplicates
      function checkDuplicate() {
        const title = document.getElementById("title").value.trim();
        if (title) {
          fetch(
            `/admin/check_duplicate/notification/${encodeURIComponent(title)}`
          )
            .then((response) => response.json())
            .then((data) => {
              const warning = document.getElementById("duplicate-warning");
              if (data.exists) {
                warning.textContent =
                  "A notification with this title already exists.";
                warning.style.display = "block";
              } else {
                warning.style.display = "none";
              }
            });
        } else {
          document.getElementById("duplicate-warning").style.display = "none";
        }
      }

      document
        .getElementById("title")
        .addEventListener("input", checkDuplicate);

      // AJAX form submission
      document
        .getElementById("notificationForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();
          const btn = document.getElementById("submitBtn");
          btn.textContent = "Saving...";
          btn.disabled = true;

          const formData = new FormData(this);
          fetch(this.action, {
            method: "POST",
            body: formData,
            headers: {
              "X-Requested-With": "XMLHttpRequest",
            },
          })
            .then((response) => response.json())
            .then((data) => {
              // Clear existing flash
              const existingFlash = document.getElementById("flash-message");
              if (existingFlash) existingFlash.remove();

              // Clear red borders
              document
                .querySelectorAll("input, select, textarea")
                .forEach((el) => (el.style.borderColor = ""));

              const msgDiv = document.createElement("div");
              msgDiv.id = "flash-message";
              msgDiv.className = data.success
                ? "alert alert-success"
                : "alert alert-danger";
              msgDiv.textContent = data.message;
              document
                .querySelector(".card-body")
                .insertBefore(
                  msgDiv,
                  document.querySelector(".card-body").firstChild
                );

              if (data.success) {
                this.reset();
                btn.textContent = "Create Notification";
                btn.disabled = false;
                setTimeout(() => {
                  msgDiv.remove();
                }, 1000);
              } else {
                btn.textContent = "Create Notification";
                btn.disabled = false;
                if (data.duplicates) {
                  data.duplicates.forEach((field) => {
                    const input = document.getElementById(field);
                    if (input) input.style.borderColor = "red";
                  });
                }
              }
            })
            .catch((error) => {
              console.error("Error:", error);
              btn.textContent = "Create Notification";
              btn.disabled = false;
            });
        });
    </script>      </div>
    </div>
  </div>
</div>